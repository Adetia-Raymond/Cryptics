name: Deploy to VPS

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-backend:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
    
    - name: Add VPS to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts
    
    - name: Deploy Backend to VPS
      run: |
        ssh ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
          # Navigate to project directory
          cd /var/www/cryptics-backend/cryptics-backend
          
          # Pull latest changes
          git pull origin main
          
          # Activate virtual environment and install dependencies
          source venv/bin/activate
          pip install --upgrade pip
          pip install fastapi uvicorn sqlalchemy psycopg2-binary redis python-dotenv pydantic pandas numpy ta
          
          # Restart the backend service
          sudo systemctl restart cryptics-backend
          
          # Wait and check if service is running
          sleep 10
          curl -f http://localhost:8000/ || echo "Backend deployment may have issues"
          
          echo "âœ… Backend deployment completed"
        EOF

  health-check:
    runs-on: ubuntu-latest
    needs: [deploy-backend]
    if: always()
    
    steps:
    - name: Check Backend Health
      run: |
        echo "ðŸ” Checking backend health..."
        curl -f http://${{ secrets.VPS_DOMAIN }}/ || echo "âŒ Backend health check failed"
        curl -f http://${{ secrets.VPS_DOMAIN }}/docs || echo "âŒ Backend /docs endpoint failed"
        
    - name: Notify Deployment Status
      if: failure()
      run: |
        echo "âŒ Deployment failed! Check the logs above."
        exit 1